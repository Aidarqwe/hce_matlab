clear;
clc;

% Заданные параметры
N = 50; % разрешение сетки
L = 0.014; % размер пластины в метрах (14 мм)
h = L / N; % размер ячейки сетки (м)

x = linspace(0, L, N);
y = linspace(0, L, N);

[X, Y] = meshgrid(x, y);

% Начальные условия
T0 = 300; % начальная температура (К)
T = T0 * ones(size(X)); % инициализация всей пластины

% Параметры временного шага
t = 0; % начальное время (с)
tmax = 60; % конечное время моделирования (с)
Nt = 1000; % количество временных шагов 
tau = (tmax - t) / Nt; % временной шаг (с)

% Граничные условия
Tb = 300; % температура на нижней границе (К)
T(1, :) = Tb; % задание температуры на нижней границе

% Свойства материала
rho = 7800; % плотность (кг/м^3)

% Параметры для теплоемкости
CpL = 458.98; % удельная теплоемкость жидкого металла (Дж/кг·К)
CpS = 692.98; % удельная теплоемкость твердого металла (Дж/кг·К)
Hm = 4e5; % скрытая теплота плавления (Дж/кг)
Tm = 1660; % температура плавления (К)
a = 3; % температурный коэффициент плавности (K)

% Формула для удельной теплоемкости
Cp = @(T) CpL + (CpS - CpL) ./ (1 + exp((T - Tm) / a)) + Hm .* exp(-((T - Tm).^2) / a^2);

% Табличные значения теплопроводности (в градусах Цельсия и Вт/м·К)
T_celsius = [30, 100, 204, 302, 404, 509, 609, 709, 806, 905, 1003, 1102, 1201, 1301]; % температуры (°C)
k_values = [15.24, 17.16, 19.61, 21.15, 23.02, 24.74, 26.71, 28.06, 28.1, 29.45, 30.02, 30.90, 34.43, 34.98]; % теплопроводности (Вт/м·К)

% Преобразование температур в Кельвины
T_kelvin = T_celsius + 273.15;

% Интерполяция теплопроводности
k_interp = @(T) interp1(T_kelvin, k_values, T, 'linear', 'extrap');

% Параметры конвекции и излучения
h_c = 5; % коэффициент теплопередачи (Вт/м^2·К)
T_ref = 300; % температура окружающей среды (К)
epsilon = 0.8; % коэффициент излучательной способности
sigma_sb = 5.67e-8; % постоянная Стефана-Больцмана (Вт/м^2·К^4)

% Параметры лазера
P = 2000; % мощность лазера (Вт)
a_laser = 1;
b_laser = 3;
r = 0.01; % радиус области воздействия лазера (м)
S = pi * r^2; % площадь пятна лазера
x_c = L / 2; % центр по x

% Индексы точки воздействия лазера
center_x = round(N / 2); % центр по x

% Запись температуры в точке воздействия лазера
time = [];
temp_laser_spot = [];

% Цикл по времени
while t < tmax
    Tprev = T;  % сохранение предыдущего распределения температур

   % Метод Гаусса-Зейделя
    for GS = 1:100
        for ix = 2:N-1
            for iy = 2:N-1
                % Рассчитываем эффективную теплоемкость в зависимости от температуры
                cp_effective = Cp(Tprev(ix, iy)); 
    
                % Коэффициенты теплопроводности соседей
                k_ip1 = k_interp(Tprev(ix+1, iy));
                k_im1 = k_interp(Tprev(ix-1, iy));
                k_jp1 = k_interp(Tprev(ix, iy+1));
                k_jm1 = k_interp(Tprev(ix, iy-1));
    
                % Сумма коэффициентов теплопроводности
                sum_k = k_ip1 + k_im1 + k_jp1 + k_jm1;
    
                % Рассчитываем сумму соседних температур
                sum_T = k_ip1 * T(ix+1, iy) + k_im1 * T(ix-1, iy) + k_jp1 * T(ix, iy+1) + k_jm1 * T(ix, iy-1);
    
                % Обновление температуры
                T(ix, iy) = (sum_T + (rho * cp_effective * h^2 / tau) * Tprev(ix, iy)) / ...
                            (rho * cp_effective * h^2 / tau + sum_k);
            end
        end
    end


    % Рассчитываем тепловой поток от конвекции и излучения на верхней границе
    q_conv = -h_c * (Tprev(end, :) - T_ref);
    q_rad = -epsilon * sigma_sb * (Tprev(end, :).^4 - T_ref^4);

    % Воздействие лазера как функция Гаусса на верхней границе
    q_laser = (P / S) * a_laser * exp(-b_laser * ((x - x_c).^2) / r^2); % формула для мощности лазера

    % Уравнение для верхней границы с учетом конвекции, излучения и лазера
    T(end, :) = Tprev(end-1, :) + h * (q_laser + q_conv + q_rad) / h_c;

    % Сохраняем температуру в точке воздействия лазера
    time(end+1) = t;
    temp_laser_spot(end+1) = T(end, center_x);

    % Визуализация
    subplot(2, 1, 1); % распределение температуры
    contourf(X, Y, T, 50, 'EdgeColor', 'none');
    xlabel('x, м');
    ylabel('y, м');
    title(sprintf('Температура пластины, К, t = %.2f с', t));
    colorbar;

    % Построение графика температуры в точке воздействия лазера
    subplot(2, 1, 2); % график температуры
    plot(time, temp_laser_spot, '-r', 'LineWidth', 2);
    xlabel('Время, с');
    ylabel('Температура, К');
    title('Температура в точке воздействия лазера');
    grid on;

    drawnow;

    % Обновление времени
    t = t + tau;
end
